# https://gist.github.com/palewire/12c4b2b974ef735d22da7493cf7f4d37
name: Release
on:
    push:
        branches:
            - main
            - github-action

jobs:
    docker-release:
        name: Tagged Docker release to Google Artifact Registry
        runs-on: ubuntu-latest
        # if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
        # <-- Notice that I'm filtering here to only run when a tagged commit is pushed

        permissions:
            contents: 'read'
            id-token: 'write'

        steps:
            - id: checkout
              name: Checkout
              uses: actions/checkout@v2

            - id: auth
              name: Authenticate with Google Cloud
              uses: google-github-actions/auth@v0
              with:
                  token_format: access_token
                  workload_identity_provider: ${{ vars.GCP_PROVIDER_ID }}
                  service_account: ${{ vars.GCP_SERVICE_ACCOUNT_EMAIL }}
                  access_token_lifetime: 300s

            - name: Login to Artifact Registry
              uses: docker/login-action@v1
              with:
                  registry: ${{ vars.GCP_REGION }}-docker.pkg.dev
                  username: oauth2accesstoken
                  password: ${{ steps.auth.outputs.access_token }}

            - name: Get tag
              id: get-tag
              run: echo ::set-output name=short_ref::${GITHUB_REF#refs/*/}

            - name: Setup Environment (PR)
              if: ${{ github.event_name == 'pull_request' }}
              shell: bash
              run: |
                  echo "LAST_COMMIT_SHA=${{ github.event.pull_request.head.sha }}" >> ${GITHUB_ENV}

            - name: Setup Environment (Push)
              if: ${{ github.event_name == 'push' }}
              shell: bash
              run: |
                  echo "LAST_COMMIT_SHA=${GITHUB_SHA}" >> ${GITHUB_ENV}

            - name: print build tag
              run: |
                  echo "BUILD_TAG=${LAST_COMMIT_SHA:0:7}" >> $GITHUB_ENV

            - id: docker-push-tagged
              name: Tag Docker image and push to Google Artifact Registry
              uses: docker/build-push-action@v2
              with:
                  push: true
                  tags: |
                      ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/cloud-run-source-deploy/shop-backend-stripe-mongo-gh-actions:${{ steps.get-tag.outputs.short_ref }}
                      ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/cloud-run-source-deploy/shop-backend-stripe-mongo-gh-actions:${{ env.BUILD_TAG }}

            - name: Print Docker tags
              run: |
                  echo "Docker tags:"
                  echo "${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/cloud-run-source-deploy/shop-backend-stripe-mongo-gh-actions:${{ steps.get-tag.outputs.short_ref }}"
                  ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/cloud-run-source-deploy/shop-backend-stripe-mongo-gh-actions:${{ env.BUILD_TAG }}
